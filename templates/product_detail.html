<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Product Details - Tofaha Site</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css"
    />
    <link rel="stylesheet" href="/static/css/style.css" />
    <style>
      .product-detail-card {
        border: none;
        border-radius: 24px;
        overflow: hidden;
        box-shadow: var(--shadow-xl);
        background: rgba(253, 242, 248, 0.9);
        border: 1px solid rgba(236, 72, 153, 0.2);
      }
      .product-gallery {
        position: relative;
        background: rgba(253, 242, 248, 0.5);
        border-radius: 24px;
        padding: 1rem;
      }
      .product-img {
        width: 100%;
        height: 400px;
        object-fit: contain;
        border-radius: 16px;
      }
      .product-info {
        padding: 2rem;
      }
      .price-tag {
        font-size: 2rem;
        color: var(--primary-color);
        font-weight: 600;
      }
      .quantity-input {
        max-width: 100px;
        text-align: center;
        border-radius: 8px;
        margin: 0 10px;
        border: 2px solid rgba(236, 72, 153, 0.2);
        background: rgba(253, 242, 248, 0.8);
      }
      .stock-badge {
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.9rem;
        background: rgba(236, 72, 153, 0.1);
      }
      .stock-badge.in-stock {
        background: rgba(16, 185, 129, 0.1);
        color: var(--success-color);
      }
      .stock-badge.low-stock {
        background: rgba(245, 158, 11, 0.1);
        color: var(--warning-color);
      }
      .related-products {
        margin-top: 3rem;
      }
    </style>
  </head>
  <body>
     <nav class="navbar navbar-expand-lg navbar-dark">
      <div class="container">
        <a class="navbar-brand" href="/"
          ><i class="bi bi-emoji-heart-eyes me-2"></i>Marsemell</a
        >
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item" id="loginNavItem">
              <a class="nav-link" href="/login/"
                ><i class="bi bi-person me-1"></i>Login</a
              >
            </li>
            <li class="nav-item" id="registerNavItem">
              <a class="nav-link" href="/register/"
                ><i class="bi bi-person-plus me-1"></i>Register</a
              >
            </li>
            <li class="nav-item" id="profileNavItem" style="display: none;">
              <a class="nav-link" href="/profile/"
                ><i class="bi bi-person-circle me-1"></i>Profile</a
              >
            </li>
            <li class="nav-item" id="logoutNavItem" style="display: none;">
              <a class="nav-link" href="#" onclick="logout()"
                ><i class="bi bi-box-arrow-right me-1"></i>Logout</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="/cart/"
                ><i class="bi bi-cart me-1"></i>Cart</a
              >
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container mt-5">
      <div class="mb-4">
        <a href="/" class="btn btn-outline-primary">
          <i class="bi bi-arrow-left me-2"></i>Back to Marsemell
        </a>
      </div>

      <div id="product-detail"></div>

      <div id="loading" class="text-center py-5">
        <div class="loading mx-auto"></div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>

      function updateNavbar() {
          const token = localStorage.getItem("access");
          const loginItem = document.getElementById("loginNavItem");
          const registerItem = document.getElementById("registerNavItem");
          const profileItem = document.getElementById("profileNavItem");
          const logoutItem = document.getElementById("logoutNavItem");

          if (token) {
              loginItem.style.display = "none";
              registerItem.style.display = "none";
              profileItem.style.display = "block";
              logoutItem.style.display = "block";
          } else {
              loginItem.style.display = "block";
              registerItem.style.display = "block";
              profileItem.style.display = "none";
              logoutItem.style.display = "none";
          }
      }


      function getProductId() {
        const params = new URLSearchParams(window.location.search);
        return params.get("id");
      }

      async function loadProduct() {
        const productId = getProductId();
        if (!productId) {
          document.getElementById("product-detail").innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle me-2"></i>No product selected
            </div>`;
          document.getElementById("loading").style.display = "none";
          return;
        }

        try {
          const res = await fetch(`/api/products/${productId}/`);
          const product = await res.json();

          document.getElementById("product-detail").innerHTML = `
            <div class="product-detail-card">
                <div class="row g-0">
                    <div class="col-lg-6">
                        <div class="product-gallery">
                            <img src="${
                              product.image ||
                              "https://via.placeholder.com/600x400"
                            }" 
                                 class="product-img" alt="${product.name}">
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="product-info">
                            <div class="mb-4">
                                ${
                                  product.category
                                    ? `<span class="badge bg-primary mb-2">${product.category.name}</span>`
                                    : ""
                                }
                                <h1 class="mb-3">${product.name}</h1>
                                <div class="d-flex align-items-center mb-2">
                                  <span class="me-2">
                                    <i class="bi bi-star-fill text-warning"></i>
                                    <i class="bi bi-star-fill text-warning"></i>
                                    <i class="bi bi-star-fill text-warning"></i>
                                    <i class="bi bi-star-fill text-warning"></i>
                                    <i class="bi bi-star-half text-warning"></i>
                                  </span>
                                  <span class="fw-semibold text-muted">4.5/5.0 (Static Review)</span>
                                </div>
                                <p class="text-muted">${product.description}</p>
                                <div class="mb-3 p-3 rounded" style="background:rgba(253,242,248,0.7);border-left:4px solid #ec4899;">
                                  <strong>About this candy:</strong><br>
                                  Indulge in the delightful world of Marsemell! This treat is crafted for those who love sweetness and joy. Enjoy its unique flavor, soft texture, and the happiness it brings to every bite. Perfect for sharing, gifting, or treating yourself to a moment of marshmallow magic.
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <span class="price-tag mb-3">$${
                                  product.price
                                }</span>
                                <div class="mt-2">
                                    <span class="stock-badge ${
                                      product.stock > 5
                                        ? "in-stock"
                                        : "low-stock"
                                    }">
                                        <i class="bi bi-box me-1"></i>
                                        ${
                                          product.stock > 0
                                            ? `${product.stock} in stock`
                                            : "Out of stock"
                                        }
                                    </span>
                                </div>
                            </div>
                            
                            <form onsubmit="event.preventDefault(); addToCart(${
                              product.id
                            })" class="mb-4">
                                <div class="d-flex align-items-center mb-3">
                                    <label class="me-3">Quantity:</label>
                                    <input type="number" id="quantity" class="form-control quantity-input" 
                                           value="1" min="1" max="${
                                             product.stock
                                           }">
                                </div>
                                <button type="submit" class="btn btn-primary btn-lg w-100 ${
                                  product.stock === 0 ? "disabled" : ""
                                }">
                                    <i class="bi bi-cart-plus me-2"></i>Add to Cart
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>`;
        } catch (error) {
          document.getElementById("product-detail").innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle me-2"></i>Failed to load product details
            </div>`;
        } finally {
          document.getElementById("loading").style.display = "none";
        }
      }

      async function addToCart(productId) {
        const token = localStorage.getItem("access");
        if (!token) {
          alert("Please login to add items to your cart.");
          window.location.href = "/login/";
          return;
        }

        const quantity = parseInt(document.getElementById("quantity").value);
        try {
          const res = await fetch("/api/cart/", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + token,
            },
            body: JSON.stringify({ product_id: productId, quantity }),
          });

          if (!res.ok) throw new Error("Failed to add to cart");

          const toast = document.createElement("div");
          toast.className = "position-fixed bottom-0 end-0 p-3";
          toast.style.zIndex = "11";
          toast.innerHTML = `
            <div class="toast show" role="alert">
                <div class="toast-header">
                    <i class="bi bi-cart-check me-2"></i>
                    <strong class="me-auto">Success</strong>
                    <button type="button" class="btn-close" onclick="this.closest('.toast').remove()"></button>
                </div>
                <div class="toast-body">
                    Product added to cart!
                </div>
            </div>
        `;
          document.body.appendChild(toast);
          setTimeout(() => toast.remove(), 3000);
        } catch (error) {
          alert(error.message);
        }
      }

      loadProduct();
          document.addEventListener("DOMContentLoaded", () => {
          updateNavbar();
      });

    </script>
  </body>
</html>
